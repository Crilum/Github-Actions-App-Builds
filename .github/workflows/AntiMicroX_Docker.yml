name: Build

on:
  push:
    branches: 
      - 'main'
    paths: 
      - 'latest_release'
  workflow_dispatch:

jobs:
  Build-arm64:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup env
        run: |
          echo "REL=$(cat latest_release)" >> $GITHUB_ENV
      - name: Set up multiarch/qemu-user-static
        run: |
          docker run --rm --privileged multiarch/qemu-user-static:register --reset
      - uses: docker://multiarch/ubuntu-core:arm64-focal
        with:
          args: >
            bash -c
            "apt update && sudo apt install doxygen dot g++ cmake extra-cmake-modules qttools5-dev qttools5-dev-tools libsdl2-dev libxi-dev libxtst-dev libx11-dev itstool gettext &&
            git clone https://github.com/AntiMicroX/antimicrox &&
            cd antimicrox &&
            mkdir build && cd build &&
            cmake .. -DCPACK_GENERATOR="DEB" -DBUILD_DOCS &&
            cmake --build . --target package
            ls"
            
      - name: Upload
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          artifacts: "pkgs/*"
          body: "# v${{env.REL}} \nRefer https://github.com/vercel/hyper/releases/tag/v${{env.REL}} \narmv7l builds use electron 17.0.0"
          name: v${{env.REL}}
          tag: v${{env.REL}}

  Build-armhf:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup env
        run: |
          echo "REL=$(cat latest_release)" >> $GITHUB_ENV
      - name: Set up multiarch/qemu-user-static
        run: |
          docker run --rm --privileged multiarch/qemu-user-static:register --reset
      - uses: docker://multiarch/ubuntu-core:armhf-focal
        with:
          args: >
            bash -c
            "apt update && sudo apt install doxygen dot g++ cmake extra-cmake-modules qttools5-dev qttools5-dev-tools libsdl2-dev libxi-dev libxtst-dev libx11-dev itstool gettext &&
            git clone https://github.com/AntiMicroX/antimicrox &&
            cd antimicrox &&
            mkdir build && cd build &&
            cmake .. -DCPACK_GENERATOR="DEB" -DBUILD_DOCS &&
            cmake --build . --target package
            ls"
            
      - name: Upload
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          artifacts: "pkgs/*"
          body: "# v${{env.REL}} \nRefer https://github.com/vercel/hyper/releases/tag/v${{env.REL}} \narmv7l builds use electron 17.0.0"
          name: ${{env.REL}}
          tag: v${{env.REL}}
